package infrastructure

import application.usecase.spin.GetPresetUsecase
import application.port.outbound.*
import application.saga.spin.end.EndSpinSaga
import application.saga.spin.place.PlaceSpinSaga
import application.saga.spin.rollback.RollbackSpinSaga
import application.saga.spin.settle.SettleSpinSaga
import application.service.GameService
import application.service.SessionService
import application.service.SpinService
import application.usecase.aggregator.*
import application.usecase.collection.*
import application.usecase.game.*
import application.usecase.provider.*
import application.usecase.session.OpenSessionUsecase
import application.usecase.spin.*
import application.service.AggregatorService
import infrastructure.messaging.messagingModule
import infrastructure.external.UnitCurrencyAdapter
import infrastructure.external.s3.S3FileAdapter
import infrastructure.external.turbo.TurboPlayerAdapter
import infrastructure.external.turbo.TurboWalletAdapter
import infrastructure.aggregator.AggregatorModule
import infrastructure.persistence.DBModule
import io.ktor.server.application.*
import org.koin.dsl.module

/**
 * Koin module for dependency injection.
 * All dependencies use constructor injection.
 */
fun Application.coreModule() = module {
    includes(
        DBModule,
        adapterModule,
        serviceModule,
        useCaseModule,
        sagaModule,
        AggregatorModule,
        messagingModule(this@coreModule)
    )
}

private val adapterModule = module {
    // ==========================================
    // Infrastructure - Ports/Adapters
    // ==========================================
    single<WalletAdapter> { TurboWalletAdapter() }
    single<PlayerAdapter> { TurboPlayerAdapter() }
    single<CurrencyAdapter> { UnitCurrencyAdapter() }
    single<FileAdapter> {
        S3FileAdapter(
            endpoint = System.getenv("S3_ENDPOINT") ?: "http://localhost:9000",
            accessKey = System.getenv("S3_ACCESS_KEY") ?: "minioadmin",
            secretKey = System.getenv("S3_SECRET_KEY") ?: "minioadmin",
            bucketName = System.getenv("S3_BUCKET") ?: "uploads",
            region = System.getenv("S3_REGION") ?: "us-east-1",
            cdnBaseUrl = System.getenv("CDN_PUBLIC_URL") ?: "http://localhost:4040"
        )
    }
}

private val serviceModule = module {
    // ==========================================
    // Application Services
    // ==========================================
    single { GameService(get(), get()) }
    single { SessionService(get(), get()) }
    single { SpinService(get(), get(), get(), get()) }
    single { AggregatorService(get(), get()) }
}

private val useCaseModule = module {
    // ==========================================
    // Application Use Cases - Game
    // ==========================================
    factory { FindGameUsecase(get()) }
    factory { ListGamesUsecase(get()) }
    factory { UpdateGameUsecase(get()) }
    factory { UpdateGameImageUsecase(get(), get()) }
    factory { AddGameTagUsecase(get()) }
    factory { RemoveGameTagUsecase(get()) }
    factory { AddGameFavouriteUsecase(get(), get(), get()) }
    factory { RemoveGameFavouriteUsecase(get(), get(), get()) }
    factory { DemoGameUsecase(get(), get()) }
    factory { AddGameWinUsecase(get(), get(), get()) }

    // ==========================================
    // Application Use Cases - Session
    // ==========================================
    factory { OpenSessionUsecase(get(), get(), get(), get()) }

    // ==========================================
    // Application Use Cases - Spin
    // ==========================================
    factory { GetPresetUsecase(get(), get()) }
    factory { CreateFreespinUsecase(get(), get()) }
    factory { CancelFreespinUsecase(get(), get()) }
    factory { GetRoundsDetailsUsecase(get()) }

    // ==========================================
    // Application Use Cases - Collection
    // ==========================================
    factory { AddCollectionUsecase(get()) }
    factory { UpdateCollectionUsecase(get()) }
    factory { AddGameCollectionUsecase(get(), get()) }
    factory { RemoveGameCollectionUsecase(get(), get()) }
    factory { ChangeGameOrderUsecase(get(), get()) }
    factory { ListCollectionUsecase(get()) }

    // ==========================================
    // Application Use Cases - Provider
    // ==========================================
    factory { ProviderListUsecase(get(), get()) }
    factory { UpdateProviderUsecase(get()) }
    factory { UpdateProviderImageUsecase(get(), get()) }
    factory { AssignProviderToAggregatorUsecase(get(), get()) }

    // ==========================================
    // Application Use Cases - Aggregator
    // ==========================================
    factory { AddAggregatorUsecase(get()) }
    factory { ListAggregatorUsecase(get()) }
    factory { ListAllActiveAggregatorUsecase(get()) }
    factory { ListGameVariantsUsecase(get()) }
    factory { SyncGameUsecase(get(), get(), get(), get(), get(), get()) }
}

private val sagaModule = module {
    // ==========================================
    // Application Sagas - Distributed Transactions
    // ==========================================
    factory { PlaceSpinSaga(get(), get(), get(), get(), get(), get(), get()) }
    factory { SettleSpinSaga(get(), get(), get(), get(), get()) }
    factory { EndSpinSaga(get(), get(), get()) }
    factory { RollbackSpinSaga(get(), get(), get(), get(), get()) }
}

/**
 * Extension to get the core module for an Application.
 */
val Application.gameCoreModule get() = coreModule()
